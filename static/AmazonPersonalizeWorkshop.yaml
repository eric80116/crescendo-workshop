---
AWSTemplateFormatVersion: '2010-09-09'

Description: Creates an S3 Bucket, IAM Policies and SageMaker Notebook to work with Personalize.

Parameters:
  NotebookName:
    Type: String
    Default: AmazonPersonalizeWorkshop
    Description: Enter the name of the SageMaker notebook instance. Default is AmazonPersonalizeWorkshop.

  VolumeSize:
    Type: Number
    Default: 64
    MinValue: 5
    MaxValue: 16384
    ConstraintDescription: Must be an integer between 5 (GB) and 16384 (16 TB).
    Description: Enter the size of the EBS volume in GB.

Resources:
  PersonalizeBucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Join [ "-", [ 'bucket-personalize', !Ref AWS::AccountId ] ]
      PublicAccessBlockConfiguration: 
        BlockPublicAcls: TRUE
        BlockPublicPolicy: TRUE
        IgnorePublicAcls: TRUE
        RestrictPublicBuckets: TRUE

  PersonalizeBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref PersonalizeBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 's3:ListBucket'
              - 's3:GetObject'
              - 's3:PutObject'
            Effect: Allow
            Principal: 
              Service:
                - 'personalize.amazonaws.com'
                - 'lambda.amazonaws.com'
            Resource:
              - !GetAtt PersonalizeBucket.Arn
              - !Join [ "/", [ !GetAtt PersonalizeBucket.Arn, '*' ] ]

  PersonalizeIamRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: Allow
            Principal:
              Service: ["personalize.amazonaws.com","lambda.amazonaws.com","kinesis.amazonaws.com","apigateway.amazonaws.com","sagemaker.amazonaws.com"]
            Action: sts:AssumeRole
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonS3FullAccess"
        - "arn:aws:iam::aws:policy/AWSLambda_FullAccess"
        - "arn:aws:iam::aws:policy/service-role/AmazonPersonalizeFullAccess"
        - "arn:aws:iam::aws:policy/AmazonKinesisFullAccess"
        - "arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"

  NotebookInstance:
    Type: "AWS::SageMaker::NotebookInstance"
    Properties:
      InstanceType: "ml.t2.medium"
      NotebookInstanceName: !Ref NotebookName
      RoleArn: !GetAtt PersonalizeIamRole.Arn
      VolumeSizeInGB: !Ref VolumeSize